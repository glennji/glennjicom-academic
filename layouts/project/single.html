{{- define "main" -}}

<div class="universal-wrapper">
  <article class="card-simple article article-project" itemscope itemtype="http://schema.org/Article">

    {{ partial "page_header.html" . }}

    <div class="article-container">
      <h2 class="post-title"><a href="{{ .Permalink }}">{{ .Title | markdownify }}</a></h2>
      <div class="article-style" itemprop="articleBody">
        {{ if .Params.crosslink }}
        {{ $related := .Site.RegularPages.RelatedIndices . "crosslink" }}
        {{ .Scratch.Set "content" .Content }}
        {{ with $related }}
        {{ range . }}
        {{ $title := .Params.title }}
        {{ $permalink := .Permalink }}

        {{ $content := replaceRE (printf "(%s)/" (lower $title)) "meeeeeeeeeeeeeep" ($.Page.Scratch.Get "content") }}
        {{ $.Page.Scratch.Set "content" $content }}

        {{ $content := replaceRE (printf "(.*)\\b(%s|%s|%s)\\b" (lower $title) $title (title $title)) (printf "$1[$2](%s)" $permalink | markdownify ) ($.Page.Scratch.Get "content") }}
        {{ $.Page.Scratch.Set "content" $content }}

        {{ $content := replaceRE "meeeeeeeeeeeeeep" (printf "%s/" (lower $title)) ($.Page.Scratch.Get "content") }}
        {{ $.Page.Scratch.Set "content" $content }}

        {{ end }}
        {{ end }}
        {{ .Scratch.Get "content" | safeHTML }}
        {{ else }}
        {{ .Content }}
        {{ end }}
      </div>

      {{ $page := . }}
      {{ $project := .File.ContentBaseName }}

      {{ $items := where (where site.RegularPages "Type" "post") ".Params.projects" "intersect" (slice $project) }}
      {{ $count := len $items }}

      {{ if ge $count 1 }}
        <hr/>
        <h2>Updates</h2>
        {{ range $items }}
          {{ if eq site.Params.projects.post_view 1 }}
            {{ partial "li_list" . }}
          {{ else if eq site.Params.projects.post_view 3 }}
            {{ partial "li_card" . }}
          {{ else }}
            {{ partial "li_compact" . }}
          {{ end }}
        {{ end }}
      {{ end }}

      {{ $items := where (where site.RegularPages "Type" "publication") ".Params.projects" "intersect" (slice $project) }}
      {{ $pubs_len := len $items }}
      {{ if ge $pubs_len 1 }}
        <h2>{{ (i18n "publications") }}</h2>
        {{ range $items }}
          {{ if eq site.Params.projects.publication_view 1 }}
            {{ partial "li_list" . }}
          {{ else if eq site.Params.projects.publication_view 3 }}
            {{ partial "li_card" . }}
          {{ else if eq site.Params.projects.publication_view 4 }}
            {{ partial "li_citation" . }}
          {{ else }}
            {{ partial "li_compact" . }}
          {{ end }}
        {{ end }}
      {{ end }}

      {{ $items := where (where site.RegularPages "Type" "talk") ".Params.projects" "intersect" (slice $project) }}
      {{ $talks_len := len $items }}
      {{ if ge $talks_len 1 }}
        <h2>{{ (i18n "talks") }}</h2>
        {{ range $items }}
          {{ if eq site.Params.projects.talk_view 1 }}
            {{ partial "li_list" . }}
          {{ else if eq site.Params.projects.talk_view 3 }}
            {{ partial "li_card" . }}
          {{ else }}
            {{ partial "li_compact" . }}
          {{ end }}
        {{ end }}
      {{ end }}

      {{ partial "page_author.html" . }}
    </div>
  </article>
</div>

{{ if site.Params.section_pager }}
<div class="article-container article-widget">
  {{ partial "section_pager.html" . }}
</div>
{{ end }}

{{- end -}}
